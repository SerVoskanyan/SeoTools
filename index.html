<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO-Анализатор для сайтов</title>
    <meta name="description" content="Легкий инструмент для SEO-анализа и аудита, разработанный для развертывания на GitHub Pages.">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
        }

        /* Custom styles for the "2015" button animation */
        #analyze-button {
            background-image: linear-gradient(to right, #3498db, #2980b9);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        #analyze-button:hover,
        #analyze-button:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen">

<div class="container max-w-4xl w-full bg-white rounded-xl shadow-lg p-6 sm:p-10 border border-gray-200">
    <header class="mb-6 text-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">SEO-Анализатор</h1>
        <p class="text-gray-600 text-sm sm:text-base">Введите URL-адрес сайта для анализа его технических SEO-параметров. Нажмите кнопку "Анализировать", чтобы начать.</p>
    </header>

    <form id="url-form" class="flex flex-col sm:flex-row gap-4 mb-6">
        <input type="url" id="url-input" placeholder="Введите URL-адрес сайта (например, https://example.com)" required
               class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button type="submit" id="analyze-button"
                class="text-white font-semibold py-3 px-6 rounded-md shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            Анализировать
            <div id="loading-spinner" class="loading-spinner hidden border-4 border-gray-200 border-t-white rounded-full w-5 h-5"></div>
        </button>
    </form>
    
    <!-- PDF Download Button (Top) -->
    <div id="pdf-buttons-top" class="hidden flex justify-center mb-6">
        <button id="download-pdf-button-top"
                class="bg-green-600 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-green-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
            Скачать отчёт в PDF
        </button>
    </div>

    <main id="results-container" class="space-y-6">
        <!-- Results will be injected here -->
    </main>

    <!-- PDF Download Button (Bottom) -->
    <div id="pdf-buttons-bottom" class="hidden flex justify-center mt-6">
        <button id="download-pdf-button-bottom"
                class="bg-green-600 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-green-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
            Скачать отчёт в PDF
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('url-form');
        const urlInput = document.getElementById('url-input');
        const analyzeButton = document.getElementById('analyze-button');
        const spinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results-container');
        const topPdfButtons = document.getElementById('pdf-buttons-top');
        const bottomPdfButtons = document.getElementById('pdf-buttons-bottom');
        const downloadPdfButtons = document.querySelectorAll('#download-pdf-button-top, #download-pdf-button-bottom');

        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const url = urlInput.value;

            // Clear previous results, hide PDF buttons, and show spinner
            resultsContainer.innerHTML = '';
            topPdfButtons.classList.add('hidden');
            bottomPdfButtons.classList.add('hidden');
            analyzeButton.disabled = true;
            spinner.classList.remove('hidden');

            try {
                // Using a proxy to bypass CORS for the main page
                const pageHtml = await fetchWithProxy(url);

                if (pageHtml.contents) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(pageHtml.contents, 'text/html');

                    const reportHtml = generateSeoReport(doc, url);
                    resultsContainer.innerHTML = reportHtml;

                    // Execute a second pass to fetch robots.txt and sitemap.xml asynchronously
                    checkRobotsAndSitemap(url);

                    // Show PDF buttons after successful report generation
                    topPdfButtons.classList.remove('hidden');
                    bottomPdfButtons.classList.remove('hidden');
                } else {
                    resultsContainer.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                        <p><strong>❌ Не удалось получить доступ к сайту.</strong><br>
                        Возможно, сайт имеет строгие настройки безопасности, которые блокируют запросы извне. Это ограничение, которое не может быть полностью решено в рамках браузера.<br>
                        <strong>Пожалуйста, попробуйте другой URL.</strong></p>
                    </div>`;
                }
            } catch (error) {
                console.error('Ошибка анализа:', error);
                resultsContainer.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p><strong>Произошла ошибка при анализе сайта.</strong> Пожалуйста, попробуйте еще раз.</p>
                </div>`;
            } finally {
                analyzeButton.disabled = false;
                spinner.classList.add('hidden');
            }
        });

        async function fetchWithProxy(url) {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                if (response.ok && data.contents) {
                    return { status: response.status, statusText: response.statusText, contents: data.contents };
                } else {
                    return { status: response.status, statusText: response.statusText, contents: null };
                }
            } catch (error) {
                console.error("Прокси-запрос не удался:", error);
                return { status: 500, statusText: 'Прокси-ошибка', contents: null };
            }
        }

        function generateSeoReport(doc, url) {
            return `
                <div class="report-section space-y-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b-2 pb-2">Сводка по анализу сайта</h2>
                    <div class="p-4 bg-blue-100 border border-blue-400 text-blue-800 rounded-md">
                        <p><strong>Анализируемый URL:</strong> <a href="${url}" target="_blank" class="text-blue-600 hover:underline">${url}</a></p>
                        <p><strong>Дата анализа:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                    </div>
                </div>
                
                <div class="report-section space-y-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b-2 pb-2">Анализ заголовков (h1-h6)</h2>
                    ${analyzeHeadings(doc)}
                </div>

                <div class="report-section space-y-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b-2 pb-2">Анализ метатегов</h2>
                    ${analyzeMetaTags(doc)}
                </div>

                <div class="report-section space-y-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b-2 pb-2">Проверка файлов robots.txt и sitemap.xml</h2>
                    <p class="text-gray-500"><strong>Внимание:</strong> Для этих проверок используется прокси-сервис для обхода CORS.</p>
                    <div id="robots-status" class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-md">Проверка robots.txt...</div>
                    <div id="sitemap-status" class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-md">Проверка sitemap.xml...</div>
                </div>
            `;
        }
        
        function analyzeHeadings(doc) {
            const headings = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
            const h1Count = doc.querySelectorAll('h1').length;
            let html = '';

            if (h1Count === 0) {
                html += `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p>❌ <strong>Критическая ошибка:</strong> Отсутствует тег <code>&lt;h1&gt;</code>. Это основной заголовок, который должен точно отражать тему страницы. <br><strong>Рекомендация:</strong> Добавьте один уникальный <code>&lt;h1&gt;</code> на страницу.</p>
                </div>`;
            } else if (h1Count > 1) {
                html += `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p>❌ <strong>Критическая ошибка:</strong> Обнаружено ${h1Count} тегов <code>&lt;h1&gt;</code>. На странице должен быть только один <code>&lt;h1&gt;</code>.<br><strong>Рекомендация:</strong> Оставьте один основной заголовок, а остальные замените на <code>&lt;h2&gt;</code> или другие заголовки более низкого уровня.</p>
                </div>`;
            } else {
                html += `<div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                    <p>✅ <strong>Отлично:</strong> Найдено 1 тег <code>&lt;h1&gt;</code>.</p>
                </div>`;
            }

            const headingLevels = Array.from(headings).map(h => parseInt(h.tagName.substring(1)));
            let isHierarchical = true;
            for (let i = 0; i < headingLevels.length - 1; i++) {
                if (headingLevels[i+1] > headingLevels[i] + 1) {
                    isHierarchical = false;
                    break;
                }
            }

            if (!isHierarchical) {
                html += `<div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-md">
                    <p>⚠️ <strong>Внимание:</strong> Нарушена иерархия заголовков. Вы пропускаете уровни (например, после <code>&lt;h2&gt;</code> идет <code>&lt;h4&gt;</code>).<br><strong>Рекомендация:</strong> Используйте заголовки последовательно, от <code>&lt;h1&gt;</code> до <code>&lt;h6&gt;</code>.</p>
                </div>`;
            } else {
                html += `<div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                    <p>✅ <strong>Отлично:</strong> Иерархия заголовков соблюдается.</p>
                </div>`;
            }
            
            if (headings.length > 0) {
                const headingList = Array.from(headings).map(h => `<li class="ml-4 list-disc"><strong>${h.tagName}:</strong> ${h.textContent.trim()}</li>`).join('');
                html += `<h4 class="font-semibold text-gray-700 mt-4">Обнаруженные заголовки:</h4><ul class="text-sm text-gray-600">${headingList}</ul>`;
            } else {
                html += `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p>❌ На странице не найдено ни одного заголовка <code>&lt;h1&gt;-&lt;h6&gt;</code>. Это ухудшает читаемость и понимание структуры сайта поисковыми системами.</p>
                </div>`;
            }
            return html;
        }

        function analyzeMetaTags(doc) {
            let html = '';

            const titleTag = doc.querySelector('title');
            if (titleTag && titleTag.textContent.length > 0) {
                html += `<div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                    <p>✅ <strong>Отлично:</strong> Тег <code>&lt;title&gt;</code> найден. <br><strong>Содержимое:</strong> "${titleTag.textContent.trim()}"</p>
                </div>`;
            } else {
                html += `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p>❌ <strong>Критическая ошибка:</strong> Отсутствует или пустой тег <code>&lt;title&gt;</code>. Это самый важный элемент для поисковых систем.<br><strong>Рекомендация:</strong> Добавьте уникальный, содержательный заголовок длиной 50-60 символов.</p>
                </div>`;
            }

            const descriptionTag = doc.querySelector('meta[name="description"]');
            if (descriptionTag && descriptionTag.getAttribute('content') && descriptionTag.getAttribute('content').length > 0) {
                html += `<div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                    <p>✅ <strong>Отлично:</strong> Тег <code>&lt;meta name="description"&gt;</code> найден.<br><strong>Содержимое:</strong> "${descriptionTag.getAttribute('content').trim()}"</p>
                </div>`;
            } else {
                html += `<div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-md">
                    <p>⚠️ <strong>Внимание:</strong> Отсутствует или пустой тег <code>&lt;meta name="description"&gt;</code>.<br><strong>Рекомендация:</strong> Добавьте уникальное описание длиной до 160 символов, которое будет отображаться в результатах поиска.</p>
                </div>`;
            }

            const robotsTag = doc.querySelector('meta[name="robots"]');
            if (robotsTag && robotsTag.getAttribute('content') && robotsTag.getAttribute('content').includes('noindex')) {
                html += `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p>❌ <strong>Предупреждение:</strong> Обнаружен тег <code>&lt;meta name="robots" content="noindex"&gt;</code>. Эта страница не будет индексироваться.<br><strong>Рекомендация:</strong> Убедитесь, что это сделано намеренно. Если нет, удалите этот тег.</p>
                </div>`;
            } else {
                html += `<div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                    <p>✅ <strong>Отлично:</strong> Не обнаружен тег <code>noindex</code> в мета-роботах.</p>
                </div>`;
            }

            const canonicalTag = doc.querySelector('link[rel="canonical"]');
            if (canonicalTag && canonicalTag.getAttribute('href') && canonicalTag.getAttribute('href').length > 0) {
                html += `<div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                    <p>✅ <strong>Отлично:</strong> Тег <code>&lt;link rel="canonical"&gt;</code> найден.<br><strong>URL:</strong> ${canonicalTag.getAttribute('href').trim()}</p>
                </div>`;
            } else {
                html += `<div class="p-4 bg-blue-100 border border-blue-400 text-blue-800 rounded-md">
                    <p>ℹ️ <strong>Информация:</strong> Тег <code>canonical</code> не найден. Это может привести к проблемам с дублированием контента, если страница доступна по нескольким URL.</p>
                </div>`;
            }
            return html;
        }

        async function fetchWithProxy(url) {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                if (response.ok && data.contents) {
                    return { status: response.status, statusText: response.statusText, contents: data.contents };
                } else {
                    return { status: response.status, statusText: response.statusText, contents: null };
                }
            } catch (error) {
                console.error("Прокси-запрос не удался:", error);
                return { status: 500, statusText: 'Прокси-ошибка', contents: null };
            }
        }

        async function checkRobotsAndSitemap(siteUrl) {
            const origin = new URL(siteUrl).origin;
            const robotsUrl = `${origin}/robots.txt`;
            const sitemapUrl = `${origin}/sitemap.xml`;
            
            const robotsStatusDiv = document.getElementById('robots-status');
            const sitemapStatusDiv = document.getElementById('sitemap-status');

            // Check robots.txt
            const robotsResult = await fetchWithProxy(robotsUrl);
            if (robotsResult.contents) {
                robotsStatusDiv.className = 'p-4 bg-green-100 border border-green-400 text-green-700 rounded-md';
                robotsStatusDiv.innerHTML = `<p>✅ <strong>Найден:</strong> Файл <code>robots.txt</code> доступен. Его содержимое:</p><pre class="mt-2 p-2 bg-gray-100 rounded-md overflow-x-auto text-sm"><code>${robotsResult.contents}</code></pre>`;
            } else {
                robotsStatusDiv.className = 'p-4 bg-red-100 border border-red-400 text-red-700 rounded-md';
                robotsStatusDiv.innerHTML = `<p>❌ <strong>Не найден:</strong> Файл <code>robots.txt</code> не доступен (${robotsResult.status} ${robotsResult.statusText}).</p>`;
            }

            // Check sitemap.xml
            const sitemapResult = await fetchWithProxy(sitemapUrl);
            if (sitemapResult.contents) {
                sitemapStatusDiv.className = 'p-4 bg-green-100 border border-green-400 text-green-700 rounded-md';
                sitemapStatusDiv.innerHTML = `<p>✅ <strong>Найден:</strong> Файл <code>sitemap.xml</code> доступен. Его содержимое:</p><pre class="mt-2 p-2 bg-gray-100 rounded-md overflow-x-auto text-sm"><code>${sitemapResult.contents}</code></pre>`;
            } else {
                sitemapStatusDiv.className = 'p-4 bg-red-100 border border-red-400 text-red-700 rounded-md';
                sitemapStatusDiv.innerHTML = `<p>❌ <strong>Не найден:</strong> Файл <code>sitemap.xml</code> не доступен (${sitemapResult.status} ${sitemapResult.statusText}).</p>`;
            }
        }
        
        // PDF download function
        downloadPdfButtons.forEach(button => {
            button.addEventListener('click', () => {
                const element = document.getElementById('results-container');
                const opt = {
                    margin: 1,
                    filename: 'seo_report.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save();
            });
        });
    });
</script>

</body>
</html>
